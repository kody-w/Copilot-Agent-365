<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Copilot Agent 365 - Chat Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 900px;
            height: 700px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-indicator.error {
            background: #ef4444;
            animation: none;
        }

        .status-indicator.warning {
            background: #f59e0b;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
            100% { box-shadow: 0 0 0 0 rgba(74, 222, 128, 0); }
        }

        .chat-title {
            flex: 1;
        }

        .chat-title h1 {
            font-size: 24px;
            font-weight: 600;
        }

        .chat-title p {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 2px;
        }

        .data-controls {
            display: flex;
            gap: 10px;
        }

        .data-controls button {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .data-controls button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .data-controls button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        .endpoint-config {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .endpoint-config input {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            width: 300px;
            font-size: 12px;
        }

        .endpoint-config input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .endpoint-config button {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
        }

        .endpoint-config button:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f9fafb;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #1f2937;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .message.assistant .message-content strong {
            color: #7c3aed;
        }

        .message.assistant .message-content code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }

        .message.error .message-content {
            background: #fee;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        .message.system .message-content {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
            font-size: 14px;
        }

        .typing-indicator {
            display: none;
            padding: 12px 16px;
            background: white;
            border-radius: 18px;
            width: fit-content;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .typing-indicator.active {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        .chat-input {
            padding: 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .input-group button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .input-group button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.3);
        }

        .input-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .action-buttons {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .action-button {
            padding: 8px 16px;
            background: #f3f4f6;
            color: #6b7280;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-button:hover {
            background: #e5e7eb;
        }

        .action-button svg {
            width: 16px;
            height: 16px;
            fill: currentColor;
        }

        /* Debug Console */
        .debug-console {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            max-width: 860px;
            margin: 0 auto;
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .debug-console.active {
            display: block;
        }

        .debug-console .debug-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #374151;
        }

        .debug-console .debug-close {
            cursor: pointer;
            color: #ef4444;
        }

        .debug-entry {
            margin: 5px 0;
            padding: 5px;
            background: #111827;
            border-radius: 4px;
        }

        .debug-entry.error {
            color: #ef4444;
            background: #7f1d1d;
        }

        .debug-entry.info {
            color: #60a5fa;
        }

        /* Hidden file input */
        input[type="file"] {
            display: none;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #4ade80;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s, slideOut 0.3s 2.7s;
            z-index: 1001;
        }

        .toast.error {
            background: #ef4444;
        }

        .toast.warning {
            background: #f59e0b;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        @keyframes slideOut {
            from { transform: translateX(0); }
            to { transform: translateX(400px); }
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .chat-container {
                height: 100vh;
                max-width: 100%;
                border-radius: 0;
            }
            
            .endpoint-config input {
                width: 200px;
            }
            
            .message-content {
                max-width: 85%;
            }

            .chat-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .data-controls {
                width: 100%;
                justify-content: space-between;
            }

            .debug-console {
                left: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="status-indicator" id="statusIndicator"></div>
            <div class="chat-title">
                <h1>Copilot Agent 365</h1>
                <p id="status">Checking connection...</p>
            </div>
            <div class="data-controls">
                <button onclick="exportConversation()" title="Export conversation as JSON">
                    <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,19L8,15H10.5V12H13.5V15H16L12,19Z"/></svg>
                    Export
                </button>
                <button onclick="document.getElementById('importFile').click()" title="Import conversation from JSON">
                    <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M12,12L8,16H10.5V19H13.5V16H16L12,12Z"/></svg>
                    Import
                </button>
            </div>
            <div class="endpoint-config">
                <input type="text" id="endpoint" placeholder="http://localhost:7071/api/businessinsightbot_function" value="http://localhost:7071/api/businessinsightbot_function">
                <button onclick="saveEndpoint()">Save</button>
            </div>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message assistant">
                <div class="message-content">
                    👋 Hello! I'm your Copilot Agent 365 assistant. How can I help you today?
                </div>
            </div>
            <div class="typing-indicator" id="typingIndicator">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
        
        <div class="chat-input">
            <div class="input-group">
                <input type="text" id="messageInput" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button id="sendButton" onclick="sendMessage()">Send</button>
            </div>
            <div class="action-buttons">
                <button class="action-button" onclick="clearChat()">
                    <svg viewBox="0 0 24 24"><path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/></svg>
                    Clear Chat
                </button>
                <button class="action-button" onclick="loadTestData()">
                    <svg viewBox="0 0 24 24"><path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M9.5,11V15.5H11V13H12.5V15.5H14V11H12.5V12.5H11V11H9.5Z"/></svg>
                    Load Test Data
                </button>
                <button class="action-button" onclick="setUserGuid()">
                    <svg viewBox="0 0 24 24"><path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/></svg>
                    Set User GUID
                </button>
                <button class="action-button" onclick="testConnection()">
                    <svg viewBox="0 0 24 24"><path d="M4.93,4.93C3.12,6.74 2,9.24 2,12C2,14.76 3.12,17.26 4.93,19.07L6.34,17.66C4.89,16.22 4,14.22 4,12C4,9.79 4.89,7.78 6.34,6.34L4.93,4.93M19.07,4.93L17.66,6.34C19.11,7.78 20,9.79 20,12C20,14.22 19.11,16.22 17.66,17.66L19.07,19.07C20.88,17.26 22,14.76 22,12C22,9.24 20.88,6.74 19.07,4.93M7.76,7.76C6.67,8.85 6,10.35 6,12C6,13.65 6.67,15.15 7.76,16.24L9.17,14.83C8.45,14.11 8,13.11 8,12C8,10.89 8.45,9.89 9.17,9.17L7.76,7.76M16.24,7.76L14.83,9.17C15.55,9.89 16,10.89 16,12C16,13.11 15.55,14.11 14.83,14.83L16.24,16.24C17.33,15.15 18,13.65 18,12C18,10.35 17.33,8.85 16.24,7.76M12,10A2,2 0 0,0 10,12A2,2 0 0,0 12,14A2,2 0 0,0 14,12A2,2 0 0,0 12,10Z"/></svg>
                    Test Connection
                </button>
                <button class="action-button" onclick="toggleDebugConsole()">
                    <svg viewBox="0 0 24 24"><path d="M13,19H14A1,1 0 0,1 15,20H22V22H15A1,1 0 0,1 14,23H10A1,1 0 0,1 9,22H2V20H9A1,1 0 0,1 10,19H11V17H4A1,1 0 0,1 3,16V4A1,1 0 0,1 4,3H20A1,1 0 0,1 21,4V16A1,1 0 0,1 20,17H13V19M5,5V14H19V5H5Z"/></svg>
                    Debug
                </button>
            </div>
        </div>
    </div>

    <!-- Debug Console -->
    <div class="debug-console" id="debugConsole">
        <div class="debug-header">
            <span>Debug Console</span>
            <span class="debug-close" onclick="toggleDebugConsole()">✕</span>
        </div>
        <div id="debugContent"></div>
    </div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" onchange="importConversation(event)">

    <script>
        let conversationHistory = [];
        let endpoint = localStorage.getItem('endpoint') || 'http://localhost:7071/api/businessinsightbot_function';
        let functionKey = localStorage.getItem('functionKey') || '';
        let currentUserGuid = localStorage.getItem('userGuid') || 'c0110700-def0-4u17-aaaa-123456789abc';
        let debugMode = false;
        
        // Initialize endpoint
        document.getElementById('endpoint').value = endpoint;
        
        function logDebug(message, type = 'info') {
            if (debugMode) {
                const debugContent = document.getElementById('debugContent');
                const entry = document.createElement('div');
                entry.className = `debug-entry ${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                debugContent.appendChild(entry);
                debugContent.scrollTop = debugContent.scrollHeight;
            }
            console.log(`[${type.toUpperCase()}]`, message);
        }
        
        function toggleDebugConsole() {
            const debugConsole = document.getElementById('debugConsole');
            debugMode = !debugMode;
            debugConsole.classList.toggle('active', debugMode);
            if (debugMode) {
                logDebug('Debug console activated', 'info');
            }
        }
        
        function updateConnectionStatus(status, message) {
            const statusIndicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('status');
            
            statusIndicator.className = 'status-indicator';
            
            switch(status) {
                case 'connected':
                    statusIndicator.classList.add('connected');
                    break;
                case 'error':
                    statusIndicator.classList.add('error');
                    break;
                case 'warning':
                    statusIndicator.classList.add('warning');
                    break;
            }
            
            statusText.textContent = message;
        }
        
        async function testConnection() {
            logDebug('Testing connection to endpoint: ' + endpoint, 'info');
            updateConnectionStatus('warning', 'Testing connection...');
            
            try {
                // Build the URL with function key if needed
                let requestUrl = endpoint;
                if (functionKey && !endpoint.includes('code=')) {
                    requestUrl += (endpoint.includes('?') ? '&' : '?') + 'code=' + functionKey;
                }
                
                // Send a minimal test request
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_input: 'test',
                        conversation_history: [],
                        user_guid: currentUserGuid
                    })
                });
                
                if (response.ok) {
                    updateConnectionStatus('connected', 'Connected to endpoint');
                    showToast('Connection successful!', 'success');
                    logDebug('Connection test successful', 'info');
                } else {
                    const errorText = await response.text();
                    updateConnectionStatus('error', `Connection failed (${response.status})`);
                    logDebug(`Connection test failed: ${response.status} - ${errorText}`, 'error');
                    
                    // Provide specific guidance based on error
                    if (response.status === 500) {
                        addMessage('⚠️ Server Error (500): The server encountered an internal error. Please check:\n\n1. Azure OpenAI credentials are configured\n2. All required agents are loaded\n3. Azure File Storage is accessible\n4. Check server logs for detailed error information', 'system');
                    } else if (response.status === 401) {
                        addMessage('⚠️ Unauthorized (401): The function key may be incorrect or missing. Please check your Azure Function key configuration.', 'system');
                    } else if (response.status === 404) {
                        addMessage('⚠️ Not Found (404): The endpoint URL may be incorrect. Please verify the function URL.', 'system');
                    }
                }
            } catch (error) {
                updateConnectionStatus('error', 'Connection failed');
                logDebug(`Connection test error: ${error.message}`, 'error');
                showToast('Connection failed: ' + error.message, 'error');
                
                // Check if it's a network error
                if (error.message.includes('Failed to fetch')) {
                    addMessage('⚠️ Network Error: Cannot reach the server. Please ensure:\n\n1. The Azure Function is running (func start)\n2. The endpoint URL is correct\n3. CORS is properly configured\n4. No firewall is blocking the connection', 'system');
                }
            }
        }
        
        function saveEndpoint() {
            endpoint = document.getElementById('endpoint').value;
            localStorage.setItem('endpoint', endpoint);
            
            // Check if there's a function key in the URL
            try {
                const url = new URL(endpoint);
                const code = url.searchParams.get('code');
                if (code) {
                    functionKey = code;
                    localStorage.setItem('functionKey', code);
                    logDebug('Function key detected and saved', 'info');
                }
            } catch (e) {
                logDebug('Invalid URL format: ' + e.message, 'error');
            }
            
            updateConnectionStatus('warning', 'Endpoint updated, testing connection...');
            testConnection();
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                sendMessage();
            }
        }
        
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            logDebug(`Sending message: ${message}`, 'info');
            
            // Disable input while processing
            input.value = '';
            input.disabled = true;
            document.getElementById('sendButton').disabled = true;
            
            // Add user message to chat
            addMessage(message, 'user');
            
            // Show typing indicator
            document.getElementById('typingIndicator').classList.add('active');
            
            try {
                // Prepare the request
                const requestBody = {
                    user_input: message,
                    conversation_history: conversationHistory,
                    user_guid: currentUserGuid
                };
                
                logDebug(`Request body: ${JSON.stringify(requestBody)}`, 'info');
                
                // Build the URL with function key if needed
                let requestUrl = endpoint;
                if (functionKey && !endpoint.includes('code=')) {
                    requestUrl += (endpoint.includes('?') ? '&' : '?') + 'code=' + functionKey;
                }
                
                // Send request to the endpoint
                const response = await fetch(requestUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });
                
                logDebug(`Response status: ${response.status}`, response.ok ? 'info' : 'error');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    logDebug(`Error response: ${errorText}`, 'error');
                    
                    // Try to parse as JSON for better error messages
                    try {
                        const errorJson = JSON.parse(errorText);
                        const errorMessage = errorJson.error || errorJson.message || `Server error (${response.status})`;
                        const errorDetails = errorJson.details || '';
                        
                        throw new Error(`${errorMessage}${errorDetails ? '\n\nDetails: ' + errorDetails : ''}`);
                    } catch (e) {
                        // If not JSON, use the status and text
                        if (response.status === 500) {
                            throw new Error(`Server Internal Error (500)\n\nPossible causes:\n• Missing Azure OpenAI credentials\n• Agent loading failures\n• Azure File Storage issues\n\nCheck server logs for details.`);
                        } else if (response.status === 401) {
                            throw new Error(`Unauthorized (401)\n\nThe function key may be incorrect or missing.`);
                        } else if (response.status === 404) {
                            throw new Error(`Not Found (404)\n\nThe endpoint URL may be incorrect.`);
                        } else {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    }
                }
                
                const data = await response.json();
                logDebug(`Response data: ${JSON.stringify(data)}`, 'info');
                
                // Add assistant response to chat
                const assistantResponse = data.assistant_response || data.response || 'No response received';
                addMessage(assistantResponse, 'assistant');
                
                // Update conversation history
                conversationHistory.push({ role: 'user', content: message });
                conversationHistory.push({ role: 'assistant', content: assistantResponse });
                
                // Update user GUID if returned
                if (data.user_guid && data.user_guid !== currentUserGuid) {
                    currentUserGuid = data.user_guid;
                    localStorage.setItem('userGuid', currentUserGuid);
                    logDebug(`User GUID updated to: ${currentUserGuid}`, 'info');
                }
                
                // Show voice response if available
                if (data.voice_response) {
                    logDebug(`Voice response: ${data.voice_response}`, 'info');
                }
                
                // Show agent logs if available
                if (data.agent_logs) {
                    logDebug(`Agent logs: ${data.agent_logs}`, 'info');
                }
                
                updateConnectionStatus('connected', 'Connected to endpoint');
                
            } catch (error) {
                console.error('Error:', error);
                logDebug(`Error: ${error.message}`, 'error');
                addMessage(`Error: ${error.message}`, 'error');
                updateConnectionStatus('error', 'Connection error');
                
                // Show help message for common issues
                if (error.message.includes('Failed to fetch')) {
                    showToast('Cannot connect to server. Is it running?', 'error');
                } else {
                    showToast('Error: Check debug console for details', 'error');
                }
            } finally {
                // Hide typing indicator and re-enable input
                document.getElementById('typingIndicator').classList.remove('active');
                input.disabled = false;
                document.getElementById('sendButton').disabled = false;
                input.focus();
            }
        }
        
        function addMessage(content, type) {
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // Parse markdown-style formatting
            let formattedContent = content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            contentDiv.innerHTML = formattedContent;
            messageDiv.appendChild(contentDiv);
            
            // Insert before typing indicator
            messagesContainer.insertBefore(messageDiv, typingIndicator);
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function clearChat() {
            conversationHistory = [];
            const messagesContainer = document.getElementById('chatMessages');
            const typingIndicator = document.getElementById('typingIndicator');
            
            // Remove all messages except the typing indicator
            while (messagesContainer.firstChild && messagesContainer.firstChild !== typingIndicator) {
                messagesContainer.removeChild(messagesContainer.firstChild);
            }
            
            // Add welcome message back
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'message assistant';
            welcomeDiv.innerHTML = `
                <div class="message-content">
                    👋 Hello! I'm your Copilot Agent 365 assistant. How can I help you today?
                </div>
            `;
            messagesContainer.insertBefore(welcomeDiv, typingIndicator);
            
            showToast('Chat cleared successfully');
            logDebug('Chat cleared', 'info');
        }
        
        function exportConversation() {
            const exportData = {
                conversation: conversationHistory,
                guid: currentUserGuid,
                timestamp: new Date().toISOString(),
                endpoint: endpoint,
                appName: "Copilot Agent 365"
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `conversation-${new Date().toISOString().replace(/:/g, '_')}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showToast('Conversation exported successfully');
            logDebug('Conversation exported', 'info');
        }
        
        function importConversation(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Clear current chat first
                    clearChat();
                    
                    // Load the conversation history
                    if (data.conversation && Array.isArray(data.conversation)) {
                        conversationHistory = data.conversation;
                        
                        // Display all messages
                        data.conversation.forEach(msg => {
                            addMessage(msg.content, msg.role);
                        });
                    }
                    
                    // Load the GUID if present
                    if (data.guid) {
                        currentUserGuid = data.guid;
                        localStorage.setItem('userGuid', currentUserGuid);
                    }
                    
                    // Optionally load the endpoint
                    if (data.endpoint && confirm('Do you want to use the endpoint from the imported file?\n' + data.endpoint)) {
                        document.getElementById('endpoint').value = data.endpoint;
                        saveEndpoint();
                    }
                    
                    showToast('Conversation imported successfully');
                    logDebug('Conversation imported', 'info');
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Error importing file: Invalid JSON format', 'error');
                    logDebug(`Import error: ${error.message}`, 'error');
                }
            };
            
            reader.readAsText(file);
            
            // Reset the file input
            event.target.value = '';
        }
        
        function loadTestData() {
            // Sample test conversation
            const testData = {
                conversation: [
                    { role: "user", content: "Hello, can you help me with memory management?" },
                    { role: "assistant", content: "Of course! I can help you manage memories in our system. Would you like to:\n\n**1. Store a new memory**\n**2. Retrieve existing memories**\n**3. Learn about memory contexts**\n\nWhat would you like to do?" },
                    { role: "user", content: "Store a memory about our Q3 sales meeting" },
                    { role: "assistant", content: "I'll help you store that memory. Please provide the details about the Q3 sales meeting that you'd like to remember.\n\n|||VOICE|||\nSure, tell me about the Q3 sales meeting and I'll save it for you." },
                    { role: "user", content: "The Q3 sales meeting is scheduled for August 15th at 2 PM. Key topics: revenue targets, new product launch, and territory expansion." },
                    { role: "assistant", content: "I've stored the memory about your Q3 sales meeting:\n\n**Meeting Details:**\n- Date: August 15th\n- Time: 2:00 PM\n- Key Topics:\n  - Revenue targets\n  - New product launch\n  - Territory expansion\n\nThis information has been saved to your memory context and will be available for future reference.\n\n|||VOICE|||\nGot it - I've saved the Q3 sales meeting details for August 15th at 2 PM." }
                ],
                guid: "test-user-" + Math.random().toString(36).substr(2, 9),
                timestamp: new Date().toISOString(),
                endpoint: endpoint,
                appName: "Copilot Agent 365 - Test Data"
            };
            
            // Clear and load the test data
            clearChat();
            conversationHistory = testData.conversation;
            currentUserGuid = testData.guid;
            localStorage.setItem('userGuid', currentUserGuid);
            
            // Display all messages
            testData.conversation.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            
            showToast('Test data loaded successfully');
            logDebug(`Test data loaded with GUID: ${currentUserGuid}`, 'info');
        }
        
        function setUserGuid() {
            const newGuid = prompt('Enter User GUID (or leave empty for default):', currentUserGuid);
            
            if (newGuid !== null) {
                // If empty, use default GUID
                currentUserGuid = newGuid.trim() || 'c0110700-def0-4u17-aaaa-123456789abc';
                localStorage.setItem('userGuid', currentUserGuid);
                
                // Optionally send just the GUID to load user context
                if (confirm('Do you want to load the memory context for this GUID?')) {
                    document.getElementById('messageInput').value = currentUserGuid;
                    sendMessage();
                }
                
                showToast('User GUID updated');
                logDebug(`User GUID updated to: ${currentUserGuid}`, 'info');
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }
        
        // Focus input on load and test connection
        window.onload = () => {
            document.getElementById('messageInput').focus();
            
            // Show current user GUID in console
            console.log('Current User GUID:', currentUserGuid);
            console.log('Endpoint:', endpoint);
            
            // Test connection on load
            testConnection();
        };
    </script>
</body>
</html>